<?xml version="1.0"?>
<project name="thirdparty" default="install" basedir=".">

  <!-- ===== Set general properties for this script ======== -->

  <property file="thirdparty.properties"/>
  <property name="thirdparty.repository" value="http://releases.opencastproject.org/3rd%20Party" />
    
  <!-- ===== Set properties for libpng ====================== -->

  <property name="libpng.url" value="${thirdparty.repository}/libpng${libpng.version}.tar.gz"/>
  <property name="build.libpng" value="${build.thirdparty}/libpng"/>
  <property name="libpng.workdir" value="${build.libpng}/libpng-${libpng.version}"/>
  <available file="${libpng.workdir}/png.h" property="libpng.downloaded"/>
  <available file="${libpng.workdir}/libpng.la" property="libpng.built"/>

  <!-- ===== Set properties for libjpeg ===================== -->

  <property name="libjpeg.url" value="${thirdparty.repository}/jpegsrc.${libjpeg.version}.tar.gz"/>
  <property name="build.libjpeg" value="${build.thirdparty}/libjpeg"/>
  <property name="libjpeg.workdir" value="${build.libjpeg}/libjpeg-${libjpeg.version}"/>
  <available file="${libjpeg.workdir}/jpeglib.h" property="libjpeg.downloaded"/>
  <available file="${libjpeg.workdir}/libjpeg.a" property="libjpeg.built"/>

  <!-- ===== Set properties for libtiff ===================== -->

  <property name="libtiff.url" value="${thirdparty.repository}/tiff${libtiff.version}.zip"/>
  <property name="build.libtiff" value="${build.thirdparty}/libtiff"/>
  <property name="libtiff.workdir" value="${build.libtiff}/libtiff-${libtiff.version}"/>
  <available file="${libtiff.workdir}/autogen.sh" property="libtiff.downloaded"/>
  <available file="${libtiff.workdir}/libtiff/libtiff.la" property="libtiff.built"/>

  <!-- ===== Set properties for jam ========================= -->

  <property name="jam.url" value="${thirdparty.repository}/jam${jam.version}.zip"/>
  <property name="build.jam" value="${build.thirdparty}/jam"/>
  <property name="jam.workdir" value="${build.jam}/jam-${jam.version}"/>
  <available file="${jam.workdir}/jam.h" property="jam.downloaded"/>
  <available file="${jam.workdir}/jam0" property="jam.built"/>

  <!-- ===== Set properties for ffmpeg ===================== -->

  <property name="ffmpeg.url" value="${thirdparty.repository}/ffmpeg${ffmpeg.revision}.tar.bz2"/>
  <property name="build.ffmpeg" value="${build.thirdparty}/ffmpeg"/>
  <property name="ffmpeg.workdir" value="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}"/>
  <available file="${ffmpeg.workdir}/version.sh" property="ffmpeg.downloaded"/>
  <available file="${ffmpeg.workdir}/ffmpeg" property="ffmpeg.built"/>

  <!-- ===== Set properties for libfaad ===================== -->

  <property name="libfaad.url" value="${thirdparty.repository}/faad2${libfaad.version}.tar.gz"/>
  <property name="build.libfaad" value="${build.thirdparty}/libfaad"/>
  <property name="libfaad.workdir" value="${build.libfaad}/faad2-${libfaad.version}"/>
    <available file="${libfaad.workdir}/configure.in" property="libfaad.downloaded"/>
  <available file="${libfaad.workdir}/libfaad/common.o" property="libfaad.built"/>

  <!-- ===== Set properties for mediainfo ==================== -->

  <property name="mediainfo.url" value="${thirdparty.repository}/MediaInfo_CLI_${mediainfo.version}_GNU_FromSource.tar.bz2"/>
  <property name="build.mediainfo" value="${build.thirdparty}/mediainfo"/>
  <property name="mediainfo.workdir" value="${build.mediainfo}/mediainfo-${mediainfo.version}"/>
  <available file="${mediainfo.workdir}/CLI_Compile.sh" property="mediainfo.downloaded"/>
  <available file="${mediainfo.workdir}/MediaInfo/Project/GNU/CLI/MediaInfo" property="mediainfo.built"/>

  <!-- ===== Set properties for opencv ===================== -->

  <property name="opencv.url" value="${thirdparty.repository}/opencv${opencv.version}.tar.gz"/>
  <property name="build.opencv" value="${build.thirdparty}/opencv"/>
  <property name="opencv.workdir" value="${build.opencv}/opencv-${opencv.version}"/>
  <available file="${opencv.workdir}/configure.in" property="opencv.downloaded"/>
  <available file="${opencv.workdir}/cv/src/cvaccum.lo" property="opencv.built"/>

  <!-- ===== Set properties for tesseract =================== -->

  <property name="tesseract.url" value="${thirdparty.repository}/tesseract${tesseract.version}.tar.gz"/>
  <property name="build.tesseract" value="${build.thirdparty}/tesseract"/>
  <property name="tesseract.workdir" value="${build.tesseract}/tesseract-${tesseract.version}"/>
  <available file="${tesseract.workdir}/eurotext.tif" property="tesseract.downloaded"/>
  <available file="${tesseract.workdir}/ccmain/adaptions.o" property="tesseract.built"/>
  
  <property name="tesseract.lang.url" value="${thirdparty.repository}/tesseract${tesseract.lang.version}.tar.gz"/>
  
  <!-- ===== Set properties for ocropus ===================== -->

  <property name="ocropus.url" value="${thirdparty.repository}/ocropus${ocropus.revision}.tar.gz"/>
  <property name="build.ocropus" value="${build.thirdparty}/ocropus"/>
  <property name="ocropus.workdir" value="${build.ocropus}/ocropus"/>
  <available file="${ocropus.workdir}/generate_version_cc.sh" property="ocropus.downloaded"/>
  <available file="${ocropus.workdir}/ocr-utils/libocrutils.a" property="ocropus.built"/>

  <!-- ===== Set properties for videosegmenter =============== -->

  <property name="videosegmenter.url" value="${thirdparty.repository}/vsegmenter${videosegmenter.version}.tar.gz"/>
  <property name="build.videosegmenter" value="${build.thirdparty}/videosegmenter"/>
  <property name="videosegmenter.workdir" value="${build.videosegmenter}/vsegmenter-${videosegmenter.version}"/>
  <available file="${videosegmenter.workdir}/videosegmenter.c" property="videosegmenter.downloaded"/>
  <available file="${videosegmenter.workdir}/videosegmenter" property="videosegmenter.built"/>
  
  <!--
  Setup things that are needed for the build.
  -->
  <target name="setup">
    <condition property="platform.supported">
      <or>
        <equals arg1="${os.name}" arg2="Mac OS X"/>
        <equals arg1="${os.name}" arg2="Linux"/>
      </or>
    </condition>
    <fail message="This platform is not supported by this installation script." unless="platform.supported"/>
    <exec outputproperty="pwd" executable="pwd"/>
  </target>

  <!-- ============================================================== -->
  <!-- [download]                                                     -->
  <!--                                                                -->
  <!-- Downloads sources for the tools built using 'thirdparty.make'  -->
  <!-- ============================================================== -->

  <target name="download" description="Downloads the sources used for the thirdparty tools build">
    <antcall target="libpng.download"/>
    <antcall target="libjpeg.download"/>
    <antcall target="libtiff.download"/>
    <antcall target="jam.download"/>
    <antcall target="ffmpeg.download"/>
    <antcall target="mediainfo.download"/>
    <antcall target="opencv.download"/>
    <antcall target="tesseract.download"/>
    <antcall target="ocropus.download"/>
    <antcall target="videosegmenter.download"/>
  </target>

  <!-- ============================================================== -->
  <!-- [install]                                                      -->
  <!--                                                                -->
  <!-- Installs the tools built using 'thirdparty.make'               -->
  <!-- ============================================================== -->

  <target name="install" description="Compiles and installs thirdparty tools">
    <echo/>
    <echo message="Make sure you execute this command as a privileged"/>
    <echo message="user, otherwise you will get 'permission denied' errors"/>
    <echo message="when packages are being installed to /usr/local"/>
    <echo/>
    <sleep seconds="5"/>

    <!-- preliminaries -->
    <antcall target="libpng.install"/>
    <antcall target="libjpeg.install"/>
    <antcall target="libtiff.install"/>
    <antcall target="jam.install"/>

    <!-- main packages -->
  <!--
    <antcall target="ffmpeg.install"/>
  -->
    <antcall target="mediainfo.install"/>
    <antcall target="opencv.install"/>
    <antcall target="tesseract.install"/>
    <antcall target="ocropus.install"/>
    <antcall target="videosegmenter.install"/>
  </target>

  <!-- ============================================================== -->
  <!-- [libpng]                                                       -->
  <!--                                                                -->
  <!-- Downloads, builds and installs libpng                          -->
  <!-- ============================================================== -->

  <!--
  Downloads libpng
  -->
  <target name="libpng.download" unless="libpng.downloaded">
    <mkdir dir="${build.libpng}" />
    <get src="${libpng.url}" dest="${build.libpng}/libpng-${libpng.version}.tar.gz"/>
    <gunzip src="${build.libpng}/libpng-${libpng.version}.tar.gz" dest="${build.libpng}/libpng-${libpng.version}.tar"/>
    <untar src="${build.libpng}/libpng-${libpng.version}.tar" dest="${build.libpng}"/>
    <delete file="${build.libpng}/libpng-${libpng.version}.tar.gz"/>
    <delete file="${build.libpng}/libpng-${libpng.version}.tar"/>
  </target>

  <target name="libpng.make" depends="setup, libpng.download" unless="libpng.built">
    <echo message="Building libpng ${libpng.version}"/>
    <property name="libpng.absworkdir" value="${pwd}/build/thirdparty/libpng/libpng-${libpng.version}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${libpng.workdir}/configure"/>
    <echo message="Configuring libpng build environment"/>
    <exec executable="${libpng.absworkdir}/configure" dir="${libpng.absworkdir}" resolveexecutable="true" failonerror="true">
      <arg line="--srcdir=${libpng.absworkdir}"/>
    </exec>
    
    <!-- make -->
    <echo message="Making libpng"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${libpng.workdir}"/>
    </exec>
  </target>

  <!--
  Installs libpng
  -->
  <target name="libpng.install" depends="libpng.make">
    <echo message="Installing libpng ${libpng.version}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" failonerror="true">
      <arg line="make -C ${libpng.workdir} install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [libjpeg]                                                      -->
  <!--                                                                -->
  <!-- Downloads, builds and installs libjpeg                         -->
  <!-- ============================================================== -->

  <!--
  Downloads libjpeg
  -->
  <target name="libjpeg.download" unless="libjpeg.downloaded">
    <mkdir dir="${build.libjpeg}"/>
    <get src="${libjpeg.url}" dest="${build.libjpeg}/libjpeg-${libjpeg.version}.tar.gz"/>
    <gunzip src="${build.libjpeg}/libjpeg-${libjpeg.version}.tar.gz" dest="${build.libjpeg}/libjpeg-${libjpeg.version}.tar"/>
    <untar src="${build.libjpeg}/libjpeg-${libjpeg.version}.tar" dest="${build.libjpeg}"/>
    <move  file="${build.libjpeg}/jpeg-6b" tofile="${libjpeg.workdir}"/>
    <delete file="${build.libjpeg}/libjpeg-${libjpeg.version}.tar.gz"/>
    <delete file="${build.libjpeg}/libjpeg-${libjpeg.version}.tar"/>
  </target>

  <!--
  Installs and patches libjpeg
  -->
  <target name="libjpeg.make" depends="setup, libjpeg.download" unless="libjpeg.built">
    <echo message="Building libjpeg ${libjpeg.version}"/>
    <property name="libjpeg.absworkdir" value="${pwd}/build/thirdparty/libjpeg/libjpeg-${libjpeg.version}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${libjpeg.workdir}/configure"/>
    <echo message="Configuring libjpeg build environment"/>
    <exec executable="${libjpeg.absworkdir}/configure" dir="${libjpeg.absworkdir}" resolveexecutable="true" failonerror="true">
      <arg line="--srcdir=${libjpeg.absworkdir}"/>
    </exec>
    
    <!-- make -->
    <echo message="Making libjpeg"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${libjpeg.workdir}"/>
    </exec>
    
    <!-- patch configure script to correctly handle source-path -->
    <exec executable="patch" searchpath="true" >
      <arg line="-p0"/>
      <arg line="-N"/>
      <arg line="${libjpeg.workdir}/Makefile"/>
      <arg line="./patches/libjpeg/Makefile.patch"/>      
    </exec>
  </target>
  
  <!--
  Installs libjpeg
  -->
  <target name="libjpeg.install" depends="libjpeg.make">
    <echo message="Installing libjpeg ${libjpeg.version}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" searchpath="true" failonerror="true">
      <arg line="make -C ${libjpeg.workdir} install install-lib"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [libtiff]                                                      -->
  <!--                                                                -->
  <!-- Downloads, builds and installs libtiff                         -->
  <!-- ============================================================== -->

  <!--
  Downloads libtiff
  -->
  <target name="libtiff.download" unless="libtiff.downloaded">
    <mkdir dir="${build.libtiff}"/>
    <get src="${libtiff.url}" dest="${build.libtiff}/libtiff-${libtiff.version}.zip"/>
    <unzip src="${build.libtiff}/libtiff-${libtiff.version}.zip" dest="${build.libtiff}"/>
    <move  file="${build.libtiff}/tiff-${libtiff.version}" tofile="${libtiff.workdir}"/>
    <delete file="${build.libtiff}/libtiff-${libtiff.version}.zip"/>
  </target>

  <!--
  Installs and patches libtiff
  -->
  <target name="libtiff.make" depends="setup, libtiff.download" unless="libtiff.built">
    <echo message="Building libtiff ${libtiff.version}"/>
    <property name="libtiff.absworkdir" value="${pwd}/build/thirdparty/libtiff/libtiff-${libtiff.version}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${libtiff.workdir}/configure"/>
    <echo message="Configuring libtiff build environment"/>
    <exec executable="${libtiff.absworkdir}/configure" dir="${libtiff.absworkdir}" resolveexecutable="true" searchpath="true" failonerror="true">
      <arg line="--srcdir=${libtiff.absworkdir}"/>
    </exec>
    
    <!-- make -->
    <echo message="Making libtiff"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${libtiff.workdir}"/>
    </exec>
  </target>
  
  <!--
  Installs libtiff
  -->
  <target name="libtiff.install" depends="libtiff.make">
    <echo message="Installing libtiff ${libtiff.version}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" searchpath="true" failonerror="true">
      <arg line="make -C ${libtiff.workdir} install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [jam]                                                          -->
  <!--                                                                -->
  <!-- Downloads, builds and installs jam                             -->
  <!-- ============================================================== -->

  <!--
  Downloads
  -->
  <target name="jam.download" unless="jam.downloaded">
    <mkdir dir="${build.jam}"/>
    <get src="${jam.url}" dest="${build.jam}/jam-${jam.version}.zip"/>
    <unzip src="${build.jam}/jam-${jam.version}.zip" dest="${jam.workdir}"/>
    <delete file="${build.jam}/jam-${jam.version}.zip"/>
  </target>

  <!--
  Builds jam
  -->
  <target name="jam.make" depends="setup,jam.download" unless="jam.built">
    <echo message="Building jam ${jam.version}"/>
    <property name="jam.absworkdir" value="${pwd}/build/thirdparty/jam/jam-${jam.version}"/>
    
    <!-- make -->
    <echo message="Making jam"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${jam.workdir}"/>
    </exec>
  </target>

  <!--
  Installs jam
  -->
  <target name="jam.install" depends="jam.make">
    <echo message="Installing jam revision ${jam.version}"/>
    <sleep seconds="1"/>
    <exec executable="jam0" dir="${jam.workdir}" resolveexecutable="true" failonerror="true">
      <arg line="install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [ffmpeg]                                                       -->
  <!--                                                                -->
  <!-- Downloads, builds and installs ffmpeg                          -->
  <!-- ============================================================== -->

  <!--
  Downloads and patches ffmpeg
  -->
  <target name="ffmpeg.download" unless="ffmpeg.downloaded">
    <mkdir dir="${build.ffmpeg}"/>
    <get src="${ffmpeg.url}" dest="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar.bz2"/>
    <bunzip2 src="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar.bz2" dest="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar"/>
    <untar src="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar" dest="${build.ffmpeg}"/>
    <delete file="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar.bz2"/>
    <delete file="${build.ffmpeg}/ffmpeg-${ffmpeg.revision}.tar"/>
    
    <!-- patch configure script to correctly handle source-path -->
    <echo message="Patching ${ffmpeg.workdir}/configure with ${pwd}/patches/ffmpeg/configure.patch"/>
    <exec executable="patch" searchpath="true">
      <arg line="--verbose"/>
      <arg line="-p0"/>
      <arg line="-N"/>
      <arg line="${ffmpeg.workdir}/configure"/>
      <arg line="./patches/ffmpeg/configure.patch"/>      
    </exec>
    <echo message="Patched ffmpeg"/>
  </target>

  <!--
  Builds ffmpeg
  -->
  <target name="ffmpeg.make" depends="setup,ffmpeg.download,libfaad.install" unless="ffmpeg.built">
    <echo message="Building ffmpeg export snapshot"/>
    <property name="ffmpeg.absworkdir" value="${pwd}/${ffmpeg.workdir}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${ffmpeg.workdir}/configure"/>
    <echo message="Configuring ffmpeg build environment"/>
    <exec executable="${ffmpeg.absworkdir}/configure" dir="${ffmpeg.absworkdir}" resolveexecutable="true" failonerror="true">
      <arg line="--source-path=${ffmpeg.absworkdir}"/>
      <arg line="--enable-gpl"/>
      <arg line="--enable-libfaad"/>
    </exec>

    <!-- make -->
    <echo message="Making ffmpeg"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${ffmpeg.workdir}"/>
    </exec>
  </target>

  <!--
  Installs ffmpeg
  -->
  <target name="ffmpeg.install" depends="ffmpeg.make">
    <echo message="Installing ffmpeg revision ${ffmpeg.revision}"/>
    <sleep seconds="1"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${ffmpeg.workdir}"/>
      <arg line="install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [mediainfo]                                                    -->
  <!--                                                                -->
  <!-- Downloads, builds and installs mediainfo                       -->
  <!-- ============================================================== -->

  <!--
  Downloads mediainfo
  -->
  <target name="mediainfo.download" unless="mediainfo.downloaded">
    <mkdir dir="${build.mediainfo}"/>
    <get src="${mediainfo.url}" dest="${build.mediainfo}/mediainfo-${mediainfo.version}.tar.bz2"/>
    <bunzip2 src="${build.mediainfo}/mediainfo-${mediainfo.version}.tar.bz2" dest="${build.mediainfo}/mediainfo-${mediainfo.version}.tar"/>
    <untar src="${build.mediainfo}/mediainfo-${mediainfo.version}.tar" dest="${build.mediainfo}/mediainfo-${mediainfo.version}"/>
    <delete file="${build.mediainfo}/mediainfo-${mediainfo.version}.tar.bz2"/>
    <delete file="${build.mediainfo}/mediainfo-${mediainfo.version}.tar"/>
  </target>

  <!--
  Builds mediainfo
  -->
  <target name="mediainfo.make" depends="setup,mediainfo.download" unless="mediainfo.built">
    <echo message="Building mediainfo ${mediainfo.version}"/>
    <property name="mediainfo.absworkdir" value="${pwd}/build/thirdparty/mediainfo/mediainfo-${mediainfo.version}/MediaInfo_CLI_GNU_FromSource"/>
    
    <!-- configure -->
    <chmod perm="755" file="${mediainfo.absworkdir}/CLI_Compile.sh"/>

    <!-- make -->
    <echo message="Making mediainfo"/>
    <exec executable="CLI_Compile.sh" resolveexecutable="true" searchpath="true" failonerror="true" dir="${mediainfo.absworkdir}" />
    <chmod perm="755" file="${mediainfo.absworkdir}/MediaInfo/Project/GNU/CLI/install-sh"/>
  </target>

  <!--
  Installs mediainfo
  -->
  <target name="mediainfo.install" depends="mediainfo.make">
    <echo message="Installing mediainfo ${mediainfo.version}"/>
    <property name="mediainfo.absworkdir" value="${pwd}/build/thirdparty/mediainfo/mediainfo-${mediainfo.version}/MediaInfo_CLI_GNU_FromSource"/>
    <sleep seconds="1"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${mediainfo.absworkdir}/MediaInfo/Project/GNU/CLI"/>
      <arg line="install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [libfaad] library used by ffmpeg to encode/decode aac/mp4a     -->
  <!-- ============================================================== -->

  <target name="libfaad.download" unless="libfaad.downloaded">
     <mkdir dir="${build.libfaad}"/>
     <get src="${libfaad.url}" dest="${build.libfaad}/libfaad-${libfaad.version}.tar.gz"/>

     <gunzip src="${build.libfaad}/libfaad-${libfaad.version}.tar.gz" dest="${build.libfaad}/libfaad-${libfaad.version}.tar"/>
     <untar src="${build.libfaad}/libfaad-${libfaad.version}.tar" dest="${build.libfaad}"/>
     <delete file="${build.libfaad}/libfaad-${libfaad.version}.tar.gz"/>
     <delete file="${build.libfaad}/libfaad-${libfaad.version}.tar"/>
  </target>

  <target name="libfaad.make" depends="setup,libfaad.download" unless="libfaad.built">
     <echo message="Building libfaad ${libfaad.version}"/>
     <property name="libfaad.absworkdir" value="${pwd}/build/thirdparty/libfaad/faad2-${libfaad.version}"/>

     <!-- bootstrap -->
     <chmod perm="755" file="${libfaad.absworkdir}/bootstrap"/>
     <echo message="Bootstrapping libfaad build environment"/>
     <exec executable="${libfaad.absworkdir}/bootstrap" dir="${libfaad.absworkdir}" resolveexecutable="true" failonerror="true"/>

     <!-- configure -->
     <chmod perm="755" file="${libfaad.absworkdir}/configure"/>
     <echo message="Configuring libfaad build environment"/>
     <exec executable="${libfaad.absworkdir}/configure" dir="${libfaad.absworkdir}" resolveexecutable="true" failonerror="true"/>

     <!-- make -->
     <echo message="Making libfaad"/>
     <exec executable="make" searchpath="true" failonerror="true">
         <arg line="-C ${libfaad.absworkdir}"/>
     </exec>
  </target>

  <target name="libfaad.install" depends="libfaad.make">
     <echo message="Installing libfaad ${libfaad.version}"/>
     <sleep seconds="1"/>
     <chmod perm="755" file="${libfaad.workdir}/install-sh"/>
     <exec executable="sudo" searchpath="true" failonerror="true">
         <arg line="make -C ${libfaad.workdir} install"/>
     </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [opencv]                                                       -->
  <!--                                                                -->
  <!-- Downloads, builds and installs opencv                          -->
  <!-- ============================================================== -->

  <!--
  Downloads opencv
  -->
  <target name="opencv.download" unless="opencv.downloaded">
    <mkdir dir="${build.opencv}"/>
    <get src="${opencv.url}" dest="${build.opencv}/opencv-${opencv.version}.tar.gz"/>
    <gunzip src="${build.opencv}/opencv-${opencv.version}.tar.gz" dest="${build.opencv}/opencv-${opencv.version}.tar"/>
    <untar src="${build.opencv}/opencv-${opencv.version}.tar" dest="${build.opencv}"/>
    <delete file="${build.opencv}/opencv-${opencv.version}.tar.gz"/>
    <delete file="${build.opencv}/opencv-${opencv.version}.tar"/>
  </target>

  <target name="opencv.make" depends="setup, opencv.download" unless="opencv.built">
    <echo message="Building opencv ${opencv.version}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${opencv.workdir}/configure"/>
    <echo message="Configuring opencv build environment"/>
    <exec executable="${pwd}/build/thirdparty/opencv/opencv-${opencv.version}/configure" dir="${opencv.workdir}" failonerror="true"/>

    <!-- make -->
    <echo message="Making opencv"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${opencv.workdir}"/>
    </exec>

    <!-- fix execute permissions -->
    <chmod perm="755" file="${opencv.workdir}/autotools/depcomp"/>
    <chmod perm="755" file="${opencv.workdir}/autotools/install-sh"/>
    <chmod perm="755" file="${opencv.workdir}/autotools/missing"/>
    <chmod perm="755" file="${opencv.workdir}/autotools/mkinstalldirs"/>
    <chmod perm="755" file="${opencv.workdir}/autotools/py-compile"/>
  </target>

  <!--
  Installs opencv
  -->
  <target name="opencv.install" depends="opencv.make">
    <echo message="Installing opencv ${opencv.version}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" searchpath="true" failonerror="true">
      <arg line="make -C ${opencv.workdir} install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [tesseract]                                                    -->
  <!--                                                                -->
  <!-- Downloads, builds and installs tesseract                       -->
  <!-- ============================================================== -->

  <!--
  Downloads tesseract
  -->
  <target name="tesseract.download" unless="tesseract.downloaded">
    <mkdir dir="${build.tesseract}"/>
    <get src="${tesseract.url}" dest="${build.tesseract}/tesseract-${tesseract.version}.tar.gz"/>
    <gunzip src="${build.tesseract}/tesseract-${tesseract.version}.tar.gz" dest="${build.tesseract}/tesseract-${tesseract.version}.tar"/>
    <untar src="${build.tesseract}/tesseract-${tesseract.version}.tar" dest="${build.tesseract}"/>
    <delete file="${build.tesseract}/tesseract-${tesseract.version}.tar.gz"/>
    <delete file="${build.tesseract}/tesseract-${tesseract.version}.tar"/>
  </target>

  <target name="tesseract.make" depends="setup, tesseract.download" unless="tesseract.built">
    <echo message="Building tesseract ${tesseract.version}"/>
    <property name="tesseract.absworkdir" value="${pwd}/build/thirdparty/tesseract/tesseract-${tesseract.version}"/>
    
    <!-- configure -->
    <chmod perm="755" file="${tesseract.workdir}/configure"/>
    <echo message="Configuring tesseract build environment"/>
    <exec executable="${tesseract.absworkdir}/configure" dir="${tesseract.absworkdir}" resolveexecutable="true" failonerror="true">
      <arg line="--srcdir=${tesseract.absworkdir}"/>
    </exec>
    
    <!-- fix execute permissions -->
    <chmod perm="755" file="${tesseract.workdir}/tessdata/makedummies"/>

    <!-- make -->
    <echo message="Making tesseract"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${tesseract.workdir}"/>
    </exec>

    <!-- download language set -->
    <get src="${tesseract.lang.url}" dest="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar.gz"/>
    <gunzip src="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar.gz" dest="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar"/>
    <untar src="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar" dest="${tesseract.workdir}" overwrite="yes"/>
    <delete file="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar.gz"/>
    <delete file="${tesseract.workdir}/tesseract-${tesseract.lang.version}.tar"/>
  </target>

  <!--
  Installs tesseract
  -->
  <target name="tesseract.install" depends="tesseract.make">
    <echo message="Installing tesseract ${tesseract.version}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" searchpath="true" failonerror="true">
      <arg line="make -C ${tesseract.workdir} install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [ocropus]                                                      -->
  <!--                                                                -->
  <!-- Downloads, builds and installs ocropus                         -->
  <!-- ============================================================== -->

  <!--
  Downloads ocropus
  -->
  <target name="ocropus.download" unless="ocropus.downloaded">
    <mkdir dir="${build.ocropus}"/>
    <get src="${ocropus.url}" dest="${build.ocropus}/ocropus-${ocropus.revision}.tar.gz"/>
    <gunzip src="${build.ocropus}/ocropus-${ocropus.revision}.tar.gz" dest="${build.ocropus}/ocropus-${ocropus.revision}.tar"/>
    <untar src="${build.ocropus}/ocropus-${ocropus.revision}.tar" dest="${build.ocropus}"/>
    <delete file="${build.ocropus}/ocropus-${ocropus.revision}.tar.gz"/>
    <delete file="${build.ocropus}/ocropus-${ocropus.revision}.tar"/>
  </target>

  <target name="ocropus.make" depends="setup, ocropus.download" unless="ocropus.built">
    <echo message="Building ocropus revision ${ocropus.revision}"/>
    <property name="ocropus.absworkdir" value="${pwd}/build/thirdparty/ocropus/ocropus"/>
    
    <!-- configure -->
    <chmod perm="755" file="${ocropus.workdir}/configure"/>
    <chmod perm="755" file="${ocropus.workdir}/generate_version_cc.sh"/>
    <echo message="Configuring ocropus build environment"/>
    <exec executable="${ocropus.absworkdir}/configure" dir="${ocropus.absworkdir}" resolveexecutable="true" failonerror="true"/>
    
    <!-- make -->
    <echo message="Making ocropus"/>
    <exec executable="/usr/local/bin/jam" dir="${ocropus.absworkdir}" resolveexecutable="true" failonerror="true"/>
  </target>

  <!--
  Installs ocropus
  -->
  <target name="ocropus.install" depends="ocropus.make">
    <property name="ocropus.absworkdir" value="${pwd}/build/thirdparty/ocropus/ocropus"/>
    <echo message="Installing ocropus revision ${ocropus.revision}"/>
    <sleep seconds="1"/>
    <exec executable="sudo" dir="${ocropus.absworkdir}" searchpath="true" failonerror="true">
      <arg line="/usr/local/bin/jam install"/>
    </exec>
  </target>

  <!-- ============================================================== -->
  <!-- [videosegmenter]                                               -->
  <!--                                                                -->
  <!-- Downloads, builds and installs the videosegmenter              -->
  <!-- ============================================================== -->

  <!--
  Downloads the videosegmenter
  -->
  <target name="videosegmenter.download" unless="videosegmenter.downloaded">
    <mkdir dir="${build.videosegmenter}"/>
    <get src="${videosegmenter.url}" dest="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar.gz"/>
    <gunzip src="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar.gz" dest="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar"/>
    <untar src="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar" dest="${build.videosegmenter}"/>
    <delete file="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar.gz"/>
    <delete file="${build.videosegmenter}/videosegmenter-${videosegmenter.version}.tar"/>
  </target>

  <target name="videosegmenter.make" depends="setup,videosegmenter.download" unless="videosegmenter.built">
    <echo message="Building videosegmenter ${videosegmenter.version}"/>
    <property name="videosegmenter.absworkdir" value="${pwd}/build/thirdparty/videosegmenter/videosegmenter-${videosegmenter.version}"/>
    
    <!-- make -->
    <echo message="Making videosegmenter"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${videosegmenter.workdir}"/>
    </exec>
  </target>

  <!--
  Installs videosegmenter
  -->
  <target name="videosegmenter.install" depends="videosegmenter.make">
    <echo message="Installing videosegmenter revision ${videosegmenter.version}"/>
    <sleep seconds="1"/>
    <exec executable="make" searchpath="true" failonerror="true">
      <arg line="-C ${videosegmenter.workdir}"/>
      <arg line="install"/>
    </exec>
  </target>

  <!-- ================================================================== -->
  <!-- Deploy thirdparty tools                                            -->
  <!-- ================================================================== -->
  <target name="installation">
    <fail unless="catalina.home" message="Please define CATALINA_HOME in your environment"/>
    <fail unless="catalina.present" message="The tomcat installation at ${catalina.home} seems to be damaged"/>
    <mkdir dir="${catalina.home}/thirdparty"/>
    
    <!-- install ant files and scripts -->
    <copy tofile="${catalina.home}/thirdparty/build.xml" file="build/scripts/thirdparty-standalone.xml"/>
    <copy todir="${catalina.home}/thirdparty">
       <fileset dir=".">
         <include name="build.properties"/>
         <include name="thirdparty.properties"/>
       </fileset>
       <fileset dir="build/scripts">
         <include name="thirdparty.xml"/>
         <include name="subversion.xml"/>
       </fileset>
       <fileset dir="build/bin">
         <include name="thirdparty.sh"/>
       </fileset>
     </copy>
     <chmod file="${catalina.home}/thirdparty/thirdparty.sh" perm="755"/>

    <!-- add patches -->
     <mkdir dir="${catalina.home}/thirdparty/build/patches"/>
     <copy todir="${catalina.home}/thirdparty/build/patches">
       <fileset dir="build/patches"/>
     </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Cleanup thirdparty files from the build directory                  -->
  <!-- ================================================================== -->
  <target name="clean" description="Remove files from the build directory">
    <delete dir="${build.thirdparty}"/>
  </target>

</project>