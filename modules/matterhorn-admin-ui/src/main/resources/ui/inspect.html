<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="css/oc.layout.css" />
    <link rel="stylesheet" type="text/css" href="css/themes/oc.default.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.6.custom.css">

    <script type="text/javascript" src="jquery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="jquery/jquery-ui-1.8.6.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="js/oc.utils.js"></script>

    <style>
      #stage {font-family:"Arial","Helvetica","Verdana","sans-serif"; font-size:10px; margin:20px; min-height:100%; padding:0 0 20px;}
      .tab-content {margin:0px 10px 10px 10px;}
      h3 {margin-top:9px;margin-bottom:3px;}
      table {font-family:"Arial","Helvetica","Verdana","sans-serif"; font-size:10px; border-top:1px solid silver;}
      tr {margin-bottom:3px; border-bottom:1px solid silver;}
      .td-key {font-weight:bold;text-align:right;}
      .td-value {font-weight:normal; text-align:left; padding-left:5px;}
    </style>

    <script type="text/javascript">
      var Opencast = Opencast || {};
      Opencast.WORKFLOW_INSTANCE_URL = '../workflow/rest/instance/';

      /* The Tabs are rendered by plugins. Plugins are stored in Opencast.renderWorkflowInstance.Renderer.
       * A render plugin is an object witht the following aspects:
       *
       * - id     : Id of the tab and the content container
       * - title  : Tab title
       * - isApplicable(workflow) : returns true if the plugin can render something given the provided workflow data
       * - render : returns a JQuery object containing content rendered by the plugin given the provided workflow data
       */

      Opencast.renderWorkflowInstance = function(workflow) {

        workflow = workflow.workflow;

        function addTab(id, title, $content) {
          // add tab header
          var $item = $('<li></li>');
          $('<a></a>').attr('href', '#'+id).text(title).appendTo($item);
          $item.appendTo('#mainContainer ul');

          // add tab content
          var $container = $('<div></div>').addClass('tab-content').attr('id', id);
          $content.appendTo($container);
          $container.appendTo('#mainContainer');
        }

        // trigger render plugins if applicable
        for (var i in Opencast.renderWorkflowInstance.Renderer) {
          var renderer = Opencast.renderWorkflowInstance.Renderer[i];
          if (renderer.isApplicable(workflow)) {
            addTab(renderer.id, renderer.title, renderer.render(workflow));
          }
        }
        $('#mainContainer').tabs();   // make tabs
      }
      Opencast.renderWorkflowInstance.Renderer = [];

      $(document).ready(function() {
        Opencast.workflowId = ocUtils.getURLParam('id');
        if (!Opencast.workflowId) {
          $('<div></div>').text('No Workflow Id parameter.').appendTo('#stage');
        } else {
          $.ajax({
            url : Opencast.WORKFLOW_INSTANCE_URL + Opencast.workflowId + ".json?jsonp=?",
            dataType: 'jsonp',
            jsonp: 'jsonp',
            success: Opencast.renderWorkflowInstance
          })
        }
      });

    </script>

    <!-- Workflow tab plugin -->
    <script id="configTmpl" type="text/x-jquery-tmpl">
      <h3>Instance</h3>
      <table>
        {{each info}}
        <tr>
          <td class="td-key">${key}</td>
          <td class="td-value">${value}</td>
        </tr>
        {{/each}}
      </table>
      <h3>Configuration</h3>
      <table>
        {{each config}}
        <tr>
          <td class="td-key">${key}</td>
          <td class="td-value">${value}</td>
        </tr>
        {{/each}}
      </table>
    </script>
    <script type="text/javascript">
      if (Opencast.renderWorkflowInstance !== undefined) {
        Opencast.renderWorkflowInstance.Renderer.push({
          id : 'config',
          title : 'Workflow',
          isApplicable : function(workflow) {return (workflow.id !== undefined);},
          render : function(workflow) {
            var data = {info:[], config:[]};
            $.each(workflow, function(key, value) {
              if (typeof workflow[key] == 'string') {
                data.info.push({key:key, value:value});
              }
            });
            // the $ configurations.configuration clashes with jQuery $ in template
            $.each(ocUtils.ensureArray(workflow.configurations.configuration), function(index, cfg) {
              data.config.push({key:cfg.key, value:cfg.$});
            });
            return $('#configTmpl').tmpl(data);
          }
        });
      }
    </script>

    <!-- Operations Log plugin -->
    <script id="operationsTmpl" type="text/x-jquery-tmpl">
      <h3>Operations</h3>
      <table>
        {{each operation}}
        <tr class="unfoldable">
          <td class="td-value"
          style="font-size: 70%;
          {{if state=='SUCCEEDED'}}color:green;{{/if}}
          {{if state=='FAILED'}}color:red;{{/if}}
          {{if state=='PAUSED'}}color:orange;{{/if}}
          {{if state=='INSTANTIATED'}}color:blue;{{/if}}
          "
          >${state}</td>
          <td class="td-value" style="font-weight:bold;">${id}</td>
          <td class="td-value">${description}</td>
        </tr>
        {{/each}}
      </table>
    </script>
    <script type="text/javascript">
      if (Opencast.renderWorkflowInstance !== undefined) {
        Opencast.renderWorkflowInstance.Renderer.push({
          id : 'operations',
          title : 'Operations Log',
          isApplicable : function(workflow) {return (workflow.operations.operation !== undefined);},
          render : function(workflow) {
            return $('#operationsTmpl').tmpl(workflow.operations);
          }
        });
      }
    </script>

    <!-- MediaPackage tab plugin -->
    <script id="mediapackageTmpl" type="text/x-jquery-tmpl">
      <h3>General Information</h3>
      <table>
        {{each info}}
        <tr>
          <td class="td-key">${key}</td>
          <td class="td-value">${value}</td>
        </tr>
        {{/each}}
      </table>
    </script>
    <script type="text/javascript">
      if (Opencast.renderWorkflowInstance !== undefined) {
        Opencast.renderWorkflowInstance.Renderer.push({
          id : 'mediapackage',
          title : 'Media Package',
          isApplicable : function(workflow) {return (workflow.mediapackage !== undefined);},
          render : function(workflow) {
            var data = {info:[], tracks:[], metadata:[], attachments:[]};
            $.each(workflow.mediapackage, function(key, value) {
              if (typeof workflow[key] == 'string') {
                data.info.push({key:key, value:value});
              }
            });
            return $('#mediapackageTmpl').tmpl(data);
          }
        });
      }
    </script>

  </head>
  <body>
    <!-- VERSION AND LOGOUT BAR -->
    <div class="layout-page-header oc-ui-version-bar ui-helper-clearfix">
      <div class="layout-inline layout-float-right"><a id="logout" href="/j_spring_security_logout">Log out</a></div>
    </div>
    <!-- BANNER -->
    <div class="layout-page-header">
      <div class="oc-ui-banner layout-inline">
        <div class="oc-ui-cursor">
          <img src="img/MatterhornLogo.png" onclick="document.location='../welcome.html'" alt="Matterhorn Home Page" title="Matterhorn Home Page" width="104" height="72" class="layout-inline" />
          <h1 id="i18n_logo_title" onclick="document.location='recordings.html'" class="layout-inline layout-valign-top">Admin Tools</h1>
        </div>
      </div>
      <div class="layout-page-banner layout-inline layout-float-right">
        <a href="http://www.opencastproject.org">
          <img src="img/OpencastLogo.png" width="143" height="38" alt="Opencast Community Project" title="Opencast Community Project" />
        </a>
      </div>
    </div>
    <!-- PAGE TABS -->
    <div class="layout-page-header">
      <ul class="layout-page-tabs oc-ui-page-tabs">
        <li class="oc-ui-page-tab oc-ui-page-tab-active oc-ui-cursor ui-corner-top" id="i18n_tab_recording" onclick="document.location='recordings.html'">Recordings</li>
        <li class="oc-ui-page-tab oc-ui-cursor ui-corner-top" id="i18n_tab_series" onclick="document.location='series_list.html'">Series</li>
        <li class="oc-ui-page-tab oc-ui-cursor ui-corner-top" id="i18n_tab_agent" onclick="document.location='agents_status.html'">Capture Agents</li>
      </ul>
    </div>
    <div id="stage">
      <div id="mainContainer">
        <ul>
        </ul>
      </div>
    </div>

    <!-- TEMPLATES -->
    <div id="templateContainer" style="display:none;">

    </div>
  </body>
</html>
