<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>Capture Agents | Opencast Matterhorn</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="shortcut icon" href="img/favicon.ico" />
        <!-- STYLESHEETS -->
        <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.6.custom.css" />
        <link rel="stylesheet" type="text/css" href="css/jquery-ui-opencast-admin/jquery-ui-opencast-admin.css" />
        <link rel="stylesheet" type="text/css" href="css/admin.css" />
        <!-- scripts -->
        <script type="text/javascript" src="jquery/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="js/oc.utils.js"></script>
        <script type="text/javascript" src="jquery/jquery-ui-1.8.1.custom.min.js"></script>
        <script type="text/javascript" src="jquery/plugins/jquery.tablesorter.min.js"></script>
	<script type="text/javascript" src="trimpath/trimpath-template-1.0.38.js"></script>

        <script type="text/javascript">
            $(document).ready( function() {              

		var polling_time;
		var last_updated;
		var agentsObj = {};
		agentsObj["agents"] = [];
		var agentsCount = undefined,dispAgCount = 0;

                $("#tabsWrapper").tabs({
                  select: function (event, ui) {
                    switch (ui.index) {
                      case 0:
                        window.location = 'recordings.html';
                        return false;
                        break;
                      case 1:
                        window.location = 'series_list.html';
                        return false;
                        break;
                      case 2:
                        window.location = 'agents_status.html';
                        return false;
                        break;
                      case 3:
                        window.location = 'statistics.html';
                        return false;
                        break;
                    }
                  },
                  selected: 2
                });	
		

		function displayAgentState(data){		
			var agent_name = "";
			dispAgCount++;
			polling_time = 0;			

			if ( data["properties-response"].properties != ""){			
				$.each(data["properties-response"].properties.item,function(a,item){				
						if (item.key==="capture.agent.state.remote.polling.interval"){
							polling_time = item.value;
						}
						if (item.key==="capture.agent.name") {
							agent_name = item.value;
						}				
				});	
			}				
			if (polling_time >0) {	
				$.each(agentsObj["agents"],function(i,item){
					if ((item.name == agent_name)&&(item["time-since-last-update"] > polling_time*1000 )) {						
						item.state = "offline";
						return false;
					}	
				});
			}
			if (agentsCount == dispAgCount) showAgentsStatus();		
		}

		function processOneAgent(agent){
			$.each(agent,function(b,property){				
				var devices,devices_arr;
				if (b==="name") {
					$.ajax({
						dataType : 'json',
						type : 'get',
						url : '/capture-admin/agents/'+property+'/configuration.json',
						success : displayAgentState
					});
				}		
				if (b==="time-since-last-update") last_updated=property;
				if ((b==="capabilities")&&(property!="")) {
					$.each(property.item,function(c,device){
						if (device.key=="capture.device.names"){									
							devices = device.value.toLowerCase().split(',');							
							devices_arr = device.value.toLowerCase().split(',');										
							return false;
						}
					});
					var i;
					agent["devices"] = devices;
					for(i=0;i<devices.length;i++) { agent.devices[i] = {"device": devices[i]}; agent.devices[i]["properties"] = []; }
					$.each(property.item,function(c,device){
						var prop = device.key.split('.');
						var name = "",i;
						for (i=3;i<prop.length;i++){ name += prop[i]+" "; }						
						var index = $.inArray( prop[2].toLowerCase(), devices_arr);
						if ( index != -1) {														
							agent.devices[index]["properties"].push({"key":name.trim(),"value":device.value});	
						}
					});
				}	
				else {
					agent[b.toString()] = property;	
				}
			});		
		}	
	
		function processAgents(data){			
			$.each(data.agents,function(a,agent){			
				if ($.isArray(agent)) { 
					$.each(agent,function(b,one){ 
						processOneAgent(one); 
					}); 
				}	
				else processOneAgent(agent);
				agentsObj.agents = $(agent).toArray();
			});
			agentsCount = agentsObj.agents.length;	
			//showAgentsStatus();									
		}		

		function showAgentsStatus(){
			var result = TrimPath.processDOMTemplate("tableTemplate", agentsObj);	
			$('#stage').empty().append(result);
			 		
			$('#captureTable').tablesorter({
				cssHeader: 'oc-ui-sortable',
				cssAsc: 'oc-ui-sortable-Ascending',
				cssDesc: 'oc-ui-sortable-Descending' ,
				headers: { 3: { sorter: false } }
			});				
										
	   
			$("ul.propnav li").click(function() { 		  
				//Drop down the subnav on click  
				$(this).find("ul.itemnav").slideDown('fast').show();
	 			
				$(this).find('ul.itemnav li span.dev-prop-val').each(function(){
					var span_len = $(this).parents('li').width()-$(this).siblings('span').width();
					if ($(this).width()>span_len) {	
						var font_size = Math.round(parseFloat($(this).css('font-size')));
						var letters = Math.floor(span_len/font_size - 3);
						$(this).attr('title',$(this).text());
						$(this).text($(this).text().substring(0,letters)+"...");													
					}
				});
			   
				$(this).hover(function() {  
				}, function(){  
					//When the mouse hovers out of the subnav, move it back up
					$(this).find("ul.itemnav").slideUp('slow');   
				});  
			   			 
			}); 				
		}

		$.ajax({
			dataType : 'json',
			type : 'get',
			url : '/capture-admin/agents.json',
			success : processAgents
		});		
		
            });
        </script>
    </head>
    <body>
        <div id="pageHeader">
            <span id="currentVersion"></span>
            <a href="/j_spring_security_logout">Log out</a>
            <div class="clear"></div>
        </div>

        <!-- notification that javaScript is disabled -->
        <noscript>
            <center>
                <div style="border:1px solid red;width:530px;margin:20px;">
                    <div style="text-align: left;background:red; color:white;padding-top:2px;padding-bottom:2px;">
                        <div class="icon icon-error" style="margin-left:5px;margin-right:5px;">&nbsp;</div>
                        JavaScript is disabled
                    </div>
                    <div style="padding:10px;">
                        JavaScript is turned off in your web browser, so this site won't work properly! <br />
                        <strong>
                            Please turn JavaScript on to use this site, then refresh the page.
                        </strong>
                    </div>
                </div>
            </center>
        </noscript>

        <div id="wrapper">
            <div id="header">
                <a href="recordings.html" style="text-decoration: none;">
                    <img src="img/MatterhornLogo.png" onclick="document.location='../welcome.html'; return false;" alt="Matterhorn Home Page" title="Matterhorn Home Page" width="104" height="72" align="left" />
                    <h1>Admin Tools</h1>
                </a>
                <a href="http://www.opencastproject.org" id="oc-logo">
                    <img src="img/OpencastLogo.png" width="143" height="38" alt="Opencast Community Project" title="Opencast Community Project" />
                </a>
                <div class="clear"></div>
            </div>

            <div id="tabsWrapper" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                <ul id="tabs">
                    <li>
                        <a href="#recordings" id="i18n_tab_recording">Recordings</a>
                    </li>
                    <li>
                        <a href="#series" id="i18n_tab_series">Series</a>
                    </li>
                    <li>
                        <a href='#agents_status' id="i18n_tab_agent">Capture Agents</a>
                    </li>
                    <li>
                        <a href="#statistics" id="i18n_tab_statistics">Statistics</a>
                    </li>
                </ul>

		
                <div id="stage" class="ui-widget ui-helper-clearfix"></div>
                
            </div><!-- END #tabsWrapper -->
		
	 <!-- JS TEMPLATE -->
        <div id="templates" style="display:none;">
      	<textarea id="tableTemplate">      		
      		<table id="captureTable" class="ui-widget" cellspacing="0" width="100%">
      		<thead>      			
					<tr>
						<th id="sortAgent" width="25%" class="ui-widget-header sortable"><div>Agent Name<div class="sort-icon ui-icon-triangle-2-n-s"></div></div></th>
						<th id="sortCapabilities" width="50%" class="ui-widget-header sortable"><div>Capabilities<div class="sort-icon ui-icon-triangle-2-n-s"></div></div></th>
						<th id="sortStatus" width="25%" class="ui-widget-header sortable"><div>Status<div class="sort-icon ui-icon-triangle-2-n-s"></div></div></th>              		
            	</tr>      		
      		</thead>
      		<tbody>
      		{for agent in agents}		
		   		 <tr>
						<td class="ui-state-active">
							<div style="margin-left:10px;"><a title="${agent.name}" href="${agent.url}">${agent.name}</a></div>
						</td>
						<td class="ui-state-active" align="center">
							{if agent.devices}
							<ul class="propnav">
								{for capability in agent.devices}														
									<li>
									<span class="subnav"></span>
									<span class="device">${capability.device}</span>
									{if capability.properties }										
										<ul class="itemnav">
											{for property in capability.properties}
											<li><span class="dev-prop">${property.key} :</span><span class="dev-prop-val">${property.value}</span>
											</li>
											{/for}
										</ul>										
									{/if}	
									</li>																	
								{/for}	
								</ul>
							{else}
							<span style="text-align:center;">No capabilities found</span>
							{/if}
						</td>
						{if agent.state}						
						  <td class="ui-state-active">
							<span class="icon icon-${agent.state}"></span>
							<span>${agent.state}</span>	
						  </td>
	    
			{else}
			<td class="ui-state-active"><td>
			{/if}
		    		</tr>
		    	{forelse}
     				<tr>
        				<td class="ui-state-active" colspan="3" align="center">
          				No Capture Agents found
        				</td>
      			</tr>
    			{/for}
      		</tbody>
      		</table>      	
      	</textarea>	

      </div>   <!-- END #templates -->  


        </div><!-- END #wrapper -->
    </body>
</html>
