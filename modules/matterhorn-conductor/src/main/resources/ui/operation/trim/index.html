  <html>
  <head>
    <title>Hold for review</title>
    <link rel="stylesheet" type="text/css" href="/admin/infusion-1.1.2/fss/css/fss-reset.css">
    <link rel="stylesheet" type="text/css" href="/admin/infusion-1.1.2/fss/css/fss-layout.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/admin.css">
    <link rel="stylesheet" type="text/css" href="/admin/css/oc.layout.css" />
    <link rel="stylesheet" type="text/css" href="/admin/css/themes/oc.default.css" />

    <link rel="stylesheet" type="text/css" href="css/pages/oc.recordings.css" />
    <link rel="stylesheet" type="text/css" href="css/tablesorter.css" />

    <style type="text/css">
      #player-container {clear:both; border:none; width:90%; height:300;}
      .hidden {display:none;}
			input.pointInput{width: 60px; border: 0px solid white;}
      #actions{margin: 0 auto; text-align:center; width:100%;}
    </style>
    <script type="text/javascript" src="/admin/jquery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/admin/jquery/jquery-ui-1.8.5.custom.min.js"></script>
    <!--<script src="engage-hybrid-player/bridge/lib/FABridge.js" type="text/javascript"></script>
    <script src="engage-hybrid-player/bridge/Videodisplay.js" type="text/javascript"></script>-->
    <script type="text/javascript">

      var PLAYER_URL = '/admin/embed.html';

      var postData = {'id' : parent.document.getElementById("holdWorkflowId").value};

      var inpoint = 0;
      var outpoint = 0;
      
      // Variables for the "In point"- and "Out point"- increase-/decrease-Buttons
      var secondsForward = 1;
      var secondsBackward = 1;
      
      var intervalTimer = 0;
      // Timeout of the Intervall Timer
      var timerTimeout = 1500;
      var timerSet = false; // -> temporary solution. clearInterval(timer) does not work properly
      $(document).ready(function() {
        var id = postData.id;
        
        
        // Set default Values for In point and Out point
        $('#player-container').load(function() {
            $('#inPoint').val("00:00:00");
        
            // Set a Timer for the while-Loop
            this.intervalTimer = window.setInterval(function() {
                // Ask if a default Out Point has been set
                if(setOutPointDefaultValue()) {
                    // Clear the Intervall
                    window.clearIntervall(this.intervalTimer);
                }
            }, timerTimeout);
        });
        
       /**
        * Tries to set the default Out point value
        */
        function setOutPointDefaultValue() {
            // If Duration has been set
            if(($('#player-container')[0].contentWindow.Opencast.Player.getDuration() != 0) && !timerSet) {
                $('#outPoint').val($('#player-container').contents().find('#oc_duration').text());
                timerSet = true;
                return true;
            }
            return false;
        }

        //create Buttons
        $('.ui-button').button();
        
        //hide some stuff we don't want to see
        window.parent.$('.paging-nav-container').hide(0);
        $('#trimming-hint').toggle();

        window.parent.$('.recordings-button-container').hide(0);
        window.parent.$('.recordings-categories').hide(0);
				window.parent.$('input#filter').parent().hide(0);

        // Event edit link clicked
        $('#edit-link').click( function () {
          //parent.Recordings.retryRecording(id);
          parent.location.href = "/admin/upload.html?retry=" + id;
          return false;
        });

        // Event set inpoint clicked
        $('#set-trimin').click( function () {
            $('#inPoint').val( $('#player-container')[0].contentWindow.Opencast.Player.getCurrentTime() );
            checkInOutPoint();
        });

        //Event set outpoint clicked
        $('#set-trimout').click( function () {
            $('#outPoint').val( $('#player-container')[0].contentWindow.Opencast.Player.getCurrentTime() );
            checkInOutPoint();
        });

        //Event forward one second (inpoint)
        $('#step-in-forward').click( function () {
            in_de_creaseObject($('#inPoint'), secondsForward);
            checkInOutPoint();
        });

        //Event backward one second (inpoint)
        $('#step-in-backward').click( function () {
            in_de_creaseObject($('#inPoint'), -secondsForward);
            checkInOutPoint();
        });

        //Event forward one second (outpoint)
        $('#step-out-forward').click( function () {
            in_de_creaseObject($('#outPoint'), secondsBackward);
            checkInOutPoint();
        });

        //Event backward one second (outpoint)
        $('#step-out-backward').click( function() {
            in_de_creaseObject($('#outPoint'), -secondsBackward);
            checkInOutPoint();
        });
        
       /**
        * Checks if In point is bigger than Out point and prints an Error Message if this is the case
        */
        function checkInOutPoint() {
            // Check if Out point is larger than the Video Duration
            if(getTimeInMilliseconds($('#outPoint').val()) > getTimeInMilliseconds($('#player-container').contents().find('#oc_duration').text())) {
                $('#outPoint').val($('#player-container').contents().find('#oc_duration').text());
            }
            // Check if In point is larger than the Video Duration
            if(getTimeInMilliseconds($('#inPoint').val()) > getTimeInMilliseconds($('#player-container').contents().find('#oc_duration').text())) {
                $('#inPoint').val($('#player-container').contents().find('#oc_duration').text());
            }
            if(getTimeInMilliseconds($('#inPoint').val()) >= getTimeInMilliseconds($('#outPoint').val())) {
                $('div#errorMessage').html("Out point must be later than In point");
                $('#trimming-hint').hide();
                $('div#errorMessage').show();
            } else {
                $('div#errorMessage').hide();
                $('#trimming-hint').show();
            }
        }

        function setValue(input, value) {
          $('#' + input).val(value);
        }

        //start playing from current in point
        $('#play-from-in').click( function () {
          var videodisplay = $('#player-container')[0].contentWindow.Videodisplay;
          videodisplay.pause();
          var seekTime = getTimeInMilliseconds($('#inPoint').val());
          videodisplay.seek(seekTime / 1000);
          window.setTimeout( function () {
            videodisplay.play();
          }, 800);
        });
        
        //play last 10 seconds to out
        $('#play-to-out').click( function () {
          var videodisplay = $('#player-container')[0].contentWindow.Videodisplay;
          videodisplay.pause();
          var seekTime = getTimeInMilliseconds($('#outPoint').val()) / 1000;
          var timeOut = 10000;
          // If Out point < 10 Seconds
          if((seekTime - 10) <= 0) {
            videodisplay.seek(0);
            timeOut = seekTime * 1000;
          } else {
            videodisplay.seek(seekTime - 10);
          }
          window.setTimeout( function () {
            videodisplay.play();
            window.setTimeout( function () {
              videodisplay.pause();
            }, timeOut);
            
          }, 800);
        });
        
        // load preview player and metadata
        $.ajax({
          url : '/workflow/rest/instance/' + id + '.xml',
          dataType : 'xml',    // or XML..
          success : function(data) {    
            // load metadata
            var catalogUrl = $(data.documentElement).find("mediapackage > metadata > catalog[type='dublincore/episode'] > url").text();
            $.ajax({
              url : catalogUrl,
              dataType: 'xml',
              error: function(XMLHttpRequest, textStatus, errorThrown) {$('div#errorMessage').html('error: ' + textStatus);},
              success: function(data) {
                $(data.documentElement).children().each(function(index, elm) {
                  var tagName = elm.tagName.split(/:/)[1];
                  if ($(elm).text() != '') {
                    $('#container-'+tagName).css('display','block');
                    var text = $('#meta-'+tagName).text();
                    if (text != '') {   // multi value? --> append value
                      $('#meta-'+tagName).text(text + ', ' + $(elm).text());
                    } else {
                      $('#meta-'+tagName).text($(elm).text());
                    }
                  }
                });
                parent.ocRecordings.adjustHoldActionPanelHeight();
              }
            });
            // get neccessary data to call the preview player
            //var previewTag = $(data.documentElement).find("mediapackage > media > track > tags > tag:contains('engage')").first();
            /*if (previewTag != null) {
              var videoUrl = $(previewTag).parent().parent().find('url').text();
              //alert("videoUrl: " + videoUrl);
              //$('#video-url-container').attr('href',videoUrl).text(videoUrl);
              var url = '/admin/embed.html?videoUrl=' + videoUrl;
              $('#player-container').attr('src', url);
            } else {
              $('#player-container').text('No preview encoded track found in MediaPackage');
            }*/
            var previewFiles = new Array();
         
            $(data.documentElement).find("mediapackage > media > track").each(function(index, elm) {
              if ($(elm).attr('type').split(/\//)[1] == 'preview') {
                previewFiles.push($(elm).find('url').text());
              }
            });
            if (previewFiles.length > 0) {
              var url = PLAYER_URL + '?';
              for (var i = 0; i < previewFiles.length; i++) {
                if (i == 0) {
                  url += 'videoUrl=';
                } else {
                  url += '&videoUrl' + (i+1) + '=';
                }
                url += previewFiles[i];
              }
              $('#player-container').attr('src', url);
            } else {
              $('#player-container').text("No preview media files found for this media package.");
            }
            // show links to source media
            var singleFile = true;
            $(data.documentElement).find("mediapackage > media > track").each(function(index, elm) {
              if ($(elm).attr('type').split(/\//)[1] == 'source') {
                var link = document.createElement('a');
                var url = $(elm).find('url').text();
                $(link).attr('href', url);
                var filename = url.split(/\//);
                $(link).text(filename[filename.length-1]).attr('title', 'Download ' + filename[filename.length-1] + ' for editing');
                if (singleFile) {
                  singleFile = false;
                } else {
                  $('#files').append($(document.createElement('span')).text(', '));
                }
                $('#files').append(link);
              }
            });
          }
        });
      });
      
    /**
      * Returns the Input Time in Milliseconds
      * @param data Data in the Format ab:cd:ef
      * @return Time from the Data in Milliseconds
      */
      function getTimeInMilliseconds(data) {
        var values = data.split(':');
        
        // If the Format is correct
        if(values.length == 3) {
            // Try to convert to Numbers
            var val0 = values[0] * 1;
            var val1 = values[1] * 1;
            var val2 = values[2] * 1;
            // Check and parse the Seconds
            if(!isNaN(val0) && !isNaN(val1) && !isNaN(val2)) {    
                // Convert Hours, Minutes and Seconds to Milliseconds
                val0 *= 60 * 60 * 1000;    // 1 Hour = 60 Minutes = 60 * 60 Seconds = 60 * 60 * 1000 Milliseconds
                val1 *= 60 * 1000;         // 1 Minute = 60 Seconds = 60 * 1000 Milliseconds
                val2 *= 1000;              // 1 Second = 1000 Milliseconds
        
                // Add the Milliseconds and return it
                return val0 + val1 + val2;
            } else {
                return 0;
            }
        } else {
            return 0;
        }
      }
      
    /**
      * Increases or decreases the current In point by val
      * @param obj Object with Function .val()
      * @param val Value in Seconds to increase (val > 0) or decrease (val < 0), val < 20 Seconds
      */
      function in_de_creaseObject(obj, val) {
        if((val != 0) && (Math.abs(val < 20))) {
            // Get current In point data
            var data = obj.val();
            // If data contains something
            if(data != '') {
                var values = data.split(':');
                if(values.length == 3) {
                    // Try to convert to Numbers
                    var val0 = values[0] * 1;
                    var val1 = values[1] * 1;
                    var val2 = values[2] * 1;
                    // Check and parse the Seconds
                    if(!isNaN(val0) && !isNaN(val1) && !isNaN(val2)) {
                        // Increase
                        if((val > 0) && ((val0 >= 0) || (val1 >= 0) || (val2 >= 0))) {
                            // If >= 59 Seconds
                            if((val2 + val) > 59) {
                                // If >= 59 Minutes
                                if((val1 + 1) > 59) {
                                    // Increase Hours and set Minutes and Seconds to 0
                                    obj.val(getTimeString(val0 + 1, 0, Math.abs(val - (60 - val2))));
                                } else {
                                    // Increase Minutes and set Seconds to the Difference
                                    obj.val(getTimeString(val0, val1 + 1, Math.abs(val - (60 - val2))));
                                }
                            } else {
                                // Increase Seconds
                                obj.val(getTimeString(val0, val1, val2 + val));
                            }
                        }
                        // Decrease
                        else if((val0 > 0) || (val1 > 0) || (val2 > 0)) {
                            // If <= 0 Seconds
                            if((val2 + val) < 0) {
                                // If <= 0 Minutes
                                if((val1 - 1) < 0) {
                                    // Decrease Hours and set Minutes and Seconds to 0
                                    obj.val(getTimeString(val0 - 1, 59, 60 - Math.abs(60 - Math.abs(val - (60 - val2)))));
                                } else {
                                    // Decrease Minutes and set Seconds to 0
                                    obj.val(getTimeString(val0, val1 - 1, 60 - Math.abs(60 - Math.abs(val - (60 - val2)))));
                                }
                            } else {
                                // Decrease Seconds
                                obj.val(getTimeString(val0, val1, val2 + val));
                            }
                        } else {
                            obj.val("00:00:00");
                        }
                    } else {
                        obj.val("00:00:00");
                    }
                } else {
                    obj.val("00:00:00");
                }
            }
        }
      }
      
     /**
      * Returns a correct formatted Time String in the Format ab:cd:ef
      * @param val0 Hours element (0, 99)
      * @param val0 Mintes element (0, 60)
      * @param val0 Seconds element (0, 60)
      * @return a correct formatted Time String in the Format ab:cd:ef
      */
      function getTimeString(val0, val1, val2) {
        if((val0 >= 0) && (val0 < 100) && (val1 >= 0) && (val1 < 60) && (val2 >= 0) && (val2 < 60)) {
            if(val0 <= 9) {
                val0 = "0" + val0.toString();
            }
            if(val1 <= 9) {
                val1 = "0" + val1.toString();
            }
            if(val2 <= 9) {
                val2 = "0" + val2.toString();
            }
            return val0 + ":" + val1 + ":" + val2;
        } else {
            return "00:00:00";
        }
      }
      
     /**
      * Continues the Workflow
      */
	  function continueWorkflow() {
        // Get Video Duration
        var videoDurationData = $('#player-container').contents().find('#oc_duration').text();
        // Format 'Trim From'
        var trimFromData = $('#inPoint').val();
        trimFromData = ((trimFromData == '') || (trimFromData == null)) ? '00:00:00' : trimFromData;
        // Format 'Trim To'
        var trimToData = $('#outPoint').val();
        trimToData = ((trimToData == '') || (trimToData == null)) ? videoDurationData : trimToData;
        
        // If Input < Output
        if(trimFromData < trimToData) {
            postData['trimin'] = getTimeInMilliseconds(trimFromData);
            postData['trimout'] = getTimeInMilliseconds(trimToData);
            parent.ocRecordings.continueWorkflow(postData);
        } else {
            $('div#errorMessage').html("The In-Point must not be bigger than the Out-Point");
        }
	  }

    function cancel() 
    {
      window.parent.location.href = window.parent.location.href;
    }
    </script>
  </head>
  <body>
    <h1>Review/Trim Media</h1>
    <center>
      <iframe id="player-container"></iframe>
    </center>
    <center>
      <!-- span>Video URL:<a id="video-url-container" href=""></a></span -->
      <br>
    </center>
    <div id="metadata-container">
      <ul class="no-bullets formField-list fl-controls-right">
        <!-- field: File -->
        <li class="ui-helper-clearfix">
          <label class="fl-label"><span id="i18n_files_label">File(s)</span>:</label>
          <div id="files"></div>
        </li>
        <!-- field: Presenter -->
        <li id="container-creator" class="ui-helper-clearfix" style="display:none;">
          <label class="fl-label"><span id="i18n_presenter_label">Presenter(s)</span>:</label>
          <span id="meta-creator"></span>
        </li>
        <!-- field: Series -->
        <li id="container-isPartOf" class="ui-helper-clearfix" style="display:none;">
          <label class="fl-label"><span id="i18n_dept_label">Series</span>:</label>
          <span id="meta-isPartOf"></span>
        </li>
        <!-- field: Description -->
        <li id="container-description" class="ui-helper-clearfix" style="display:none;">
          <label class="fl-label"><span id="i18n_dept_label">Description</span>:</label>
          <span id="meta-description"></span>
        </li>
        <!-- field: Distribution channels -->
        <li id="container-dist" class="ui-helper-clearfix" style="display:none;">
          <label class="fl-label"><span id="i18n_dept_label">Distribution channels</span>:</label>
          <span id="meta-dist"></span>
        </li>
      </ul>
    </div>
    <div id="actions">
         <!-- control buttons -->

         <label for="inPoint" style="padding-left: 10px">In point</label>
          <input type="text" id="inPoint" readonly="readonly" class="pointInput"></input> 
          <input type="button" style="width: 160px;" id="set-trimin" title="Set to current time" value="Set to current time" class="ui-button" />
          <input type="button" id="play-from-in" style="width: 160px;"  title="Start playing at current In point" value="&gt; Play from In point" class="ui-button" /> 
          <input type="button" id="step-in-forward" title="Increase In point by one second" value="&gt;&gt;" class="ui-button" />
          <input type="button" id="step-in-backward" title="Decrease In point by one second" value="&lt;&lt;" class="ui-button" /><br />
         <label for="outPoint" class="label">Out point</label> 
          <input type="text" id="outPoint" readonly="readonly" class="pointInput"></input> 
          <input type="button" style="width: 160px;" id="set-trimout" title="Set to current time" value="Set to current time" class="ui-button" /> 
          <input type="button" id="play-to-out" style="width: 160px;" title="Play last 10 seconds to Out point" value="&gt; Play to Out point" class="ui-button" />
          <input type="button" id="step-out-forward" title="Increase Out point by one second" value="&gt;&gt;" class="ui-button" />
          <input type="button" id="step-out-backward" title="Decrease Out point by one second" value="&lt;&lt;" class="ui-button" /><br />
          <br />
         <div id="errorMessage" class="error">
         </div>
         <div id="trimming-hint">
          <p style="color:green;">This Recording will be trimmed according to the In and Out points you have set when you continue.</p>
         </div>
         <input title="Start trimming this recording" 
                style="margin-left: 65px; margin-right: 16px; width: 160px;" 
                onclick="continueWorkflow();" 
                id="continueBtn" 
                type="button"
                class="ui-button ui-corner-all"
                value="Continue processing" />
         <a id="edit-link" style="margin-right: 16px;">Edit before continuing</a>
         <a onclick="cancel()" title="Cancel" style="margin-right: 16px;">Cancel</a>
     </div>
  </body>
</html>

