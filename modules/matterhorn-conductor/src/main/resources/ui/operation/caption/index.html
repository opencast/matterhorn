<html>
  <head>
    <title>Hold for review</title>
    <link rel="stylesheet" type="text/css" href="../../../admin/infusion-1.1.2/fss/css/fss-reset.css">
    <link rel="stylesheet" type="text/css" href="../../../admin/infusion-1.1.2/fss/css/fss-layout.css">
    <link rel="stylesheet" type="text/css" href="../../../admin/css/admin.css">
    <style type="text/css">
      #player-container {clear:both; border:none; width:90%; height:300;}
      #edit-link {float:right;margin-top:3px; margin-bottom:5px; margin-right:50px;}
      .hidden-initialy {display:none;}
    </style>
    <script type="text/javascript" src="../../../admin/jquery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript">

      var PLAYER_URL = '../../../engage/ui/embed.html';

      function xmlToString(doc) {
        if(typeof XMLSerializer != 'undefined'){
          return (new XMLSerializer()).serializeToString(doc);
        } else if(doc.xml) {
          return doc.xml;
        } else {
          return '';
        }
      }

      $(document).ready(function() {
        var id = parent.document.getElementById("holdWorkflowId").value;
        // Event edit link clicked
        $('#edit-link').click( function() {
          //parent.Recordings.retryRecording(id);
          parent.location.href = "../../../admin/upload.html?retry=" + id;
          return false;
        });
        // load preview player and metadata
        $.ajax({
          url : '../../../workflow/rest/instance/' + id + '.xml',
          dataType : 'xml',    
          success : function(data) {
            // put mediapackge into form (for upload of captions file)
            var mp = xmlToString(data).match(/<mediapackage(.*)mediapackage>/)[0];
            $('#mediaPackage').val(mp);
            // load metadata
            var catalogUrl = $(data.documentElement).find("mediapackage > metadata > catalog[type='dublincore/episode'] > url").text();
            $.ajax({
              url : catalogUrl,
              dataType: 'xml',
              error: function(XMLHttpRequest, textStatus, errorThrown) {alert('error: ' + textStatus);},
              success: function(data) {
                $(data.documentElement).children().each(function(index, elm) {
                  var tagName = elm.tagName.split(/:/)[1];
                  if ($(elm).text() != '') {
                    $('#container-'+tagName).css('display','block');
                    var text = $('#meta-'+tagName).text();
                    if (text != '') {   // multi value? --> append value
                      $('#meta-'+tagName).text(text + ', ' + $(elm).text());
                    } else {
                      $('#meta-'+tagName).text($(elm).text());
                    }
                  }
                });
                parent.Recordings.adjustHoldActionPanelHeight();
              }
            });
            // call preview player
            var previewFiles = new Array();
            $(data.documentElement).find("mediapackage > media > track").each(function(index, elm) {
              if ($(elm).attr('type').split(/\//)[1] == 'preview') {
                previewFiles.push($(elm).find('url').text());
              }
            });
            if (previewFiles.length > 0) {
              var url = PLAYER_URL + '?';
              for (var i = 0; i < previewFiles.length; i++) {
                if (i == 0) {
                  url += 'videoUrl=';
                } else {
                  url += '&videoUrl' + (i+1) + '=';
                }
                url += previewFiles[i];
              }
              $('#player-container').attr('src', url);
            } else {
              $('#player-container').text("No preview media files found for this media package.");
            }
            // show links to source media
            var singleFile = true;
            $(data.documentElement).find("mediapackage > media > track").each(function(index, elm) {
              if ($(elm).attr('type').split(/\//)[1] == 'source') {
                var link = document.createElement('a');
                var url = $(elm).find('url').text();
                $(link).attr('href', url);
                var filename = url.split(/\//);
                $(link).text(filename[filename.length-1]).attr('title', 'Download ' + filename[filename.length-1] + ' for editing');
                if (singleFile) {
                  singleFile = false;
                } else {
                  $('#files').append($(document.createElement('span')).text(', '));
                }
                $('#files').append(link);
              }
            });
          }
        });
      });
    </script>
  </head>
  <body>
    <!-- control buttons in the upper right -->
    <a href="javascript: return false;" id="edit-link">Edit before continuing</a>
    <center>
      <iframe id="player-container"></iframe>
    </center>
    <div id="metadata-container">
      <form action="../../../ingest/rest/addCatalog" method="POST" enctype="multipart/form-data">
        <ul class="no-bullets formField-list fl-controls-right">
          <!-- captions files upload -->
          <li class="ui-helper-clearfix">
            <label class="fl-label"><span id="i18n_captions_upload_label">Upload a captions files</span>:</label>
            <input type="hidden" name="falvor" value="captions/timedtext">
            <input type="hidden" id="mediaPackage" name="mediaPackage" value="">
            <input type="file" name="file">
            <input type="submit" value="Upload file">
          </li>
          <!-- field: File -->
          <li class="ui-helper-clearfix">
            <label class="fl-label"><span id="i18n_files_label">File(s)</span>:</label>
            <div id="files"></div>
          </li>
          <!-- field: Title -->
          <li id="container-title" class="ui-helper-clearfix" style="display:none;">
            <label class="fl-label"><span id="i18n_title_label">Title</span>:</label>
            <span id="meta-title"></span>
          </li>
          <!-- field: Presenter -->
          <li id="container-creator" class="ui-helper-clearfix" style="display:none;">
            <label class="fl-label"><span id="i18n_presenter_label">Presenter(s)</span>:</label>
            <span id="meta-creator"></span>
          </li>
          <!-- field: Series -->
          <li id="container-isPartOf" class="ui-helper-clearfix" style="display:none;">
            <label class="fl-label"><span id="i18n_dept_label">Series</span>:</label>
            <span id="meta-isPartOf"></span>
          </li>
          <!-- field: Description -->
          <li id="container-description" class="ui-helper-clearfix" style="display:none;">
            <label class="fl-label"><span id="i18n_dept_label">Description</span>:</label>
            <span id="meta-description"></span>
          </li>
          <!-- field: Distribution channels -->
          <li id="container-dist" class="ui-helper-clearfix" style="display:none;">
            <label class="fl-label"><span id="i18n_dept_label">Distribution channels</span>:</label>
            <span id="meta-dist"></span>
          </li>
        </ul>
      </form>
    </div>
  </body>
</html>

