<html>
	<head>
		<title>Hold for export</title>
		<link rel="stylesheet" type="text/css" href="/admin/css/jquery-ui-1.8.6.custom.css" />
		<link rel="stylesheet" type="text/css" href="/admin/css/jquery-ui-opencast-admin/jquery-ui-opencast-admin.css" />   
		<link rel="stylesheet" type="text/css" href="/admin/css/admin.css">
		<script type="text/javascript" src="/admin/jquery/jquery-1.4.4.min.js"></script>
		<script type="text/javascript" src="/admin/jquery/jquery-ui-1.8.9.custom.min.js"></script>    
		<script type="text/javascript" src="/admin/js/oc.utils.js"></script>
    	<script type="text/javascript" src="/admin/trimpath/trimpath-template-1.0.38.js"></script>
    
    <!-- link rel="stylesheet" type="text/css" href="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/css/jquery-ui-1.8.6.custom.css" />
    <link rel="stylesheet" type="text/css" href="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/css/jquery-ui-opencast-admin/jquery-ui-opencast-admin.css" />   
    <link rel="stylesheet" type="text/css" href="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/css/admin.css">
    <script type="text/javascript" src="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/jquery/jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/jquery/jquery-ui-1.8.9.custom.min.js"></script>    
    <script type="text/javascript" src="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/js/oc.utils.js"></script>
    <script type="text/javascript" src="file:///home/akm220/workspace/matterhorn/MH-8395/shared-resources/trimpath/trimpath-template-1.0.38.js"></script-->

<script type="text/javascript">
	var postData = {
		'id': parent.document.getElementById("holdWorkflowId").value
	};

	var templateFrames = '{for f in frames}' +
                                '<div ' +
                                    'id="${f.id}" ' +
                                    'class="source-frame" ' +
                                    'style="width:100%; height:20%; background-color: blue;" ' +
                                 '>' +
                                  '<span id="${f.id}_width" style="display: none">${f.width}</span>' +
                                  '<span id="${f.id}_height" style="display: none">${f.height}</span>' +
                                '</div><p></p>' +
                              '{/for}';

	var cameraScreenAudioTemplate = "filesrc location=VGA ! decodebin2 name=VgaDecodeBin ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"videobox border-alpha=1 top=0 bottom=0 left=-CAMERAWIDTH ! " +
		"videomixer name=mix sink_0::alpha=1 sink_1::alpha=1 background=black ! " +
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=3 ! queue name=camera ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=CAMERA ! decodebin2 name=CameraDecodeBin ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! mix. " +
		"filesrc location=AUDIO ! decodebin2 name=AudioDecodeBin ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux."
                              
	var screenAudioTemplate = "filesrc location=VGA ! decodebin2 ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=3 ! queue name=camera ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=AUDIO ! decodebin2 ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux."

	var mobileTemplate = "filesrc location=VGA ! decodebin2 ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"videoscale ! video/x-raw-yuv,width=640,height=480 ! " +
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=1 ! queue name=vga ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=AUDIO ! decodebin2 ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux." 
      
	var tabletTemplate = "filesrc location=VGA ! decodebin2 ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"videoscale ! video/x-raw-yuv,width=1024,height=768 ! " + 
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=3 ! queue name=vga ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=AUDIO ! decodebin2 ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux."
      
	var hdTemplate = "filesrc location=VGA ! decodebin2 ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"videoscale ! video/x-raw-yuv,width=1280,height=720 ! " + 
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=3 ! queue name=vga ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=AUDIO ! decodebin2 ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux."
      
	var fullHDTemplate = "filesrc location=VGA ! decodebin2 ! videorate ! video/x-raw-yuv,framerate=\(fraction\)30/1 ! " +
		"videoscale ! video/x-raw-yuv,width=1920,height=1080 ! " + 
		"ffmpegcolorspace ! x264enc pass=5 quantizer=25 speed-preset=6 profile=3 ! queue name=vga ! mp4mux name=mux ! filesink location=OUTPUTFILE " +
		"filesrc location=AUDIO ! decodebin2 ! audioconvert ! audio/x-raw-int,rate=44100,channels=2 ! faac bitrate=160000 profile=2 ! queue name=audio ! mux."
          
	$(document).ready(function() {
		var id = postData.id;             
		
        // load preview player and metadata
		$.ajax({
			url: '/workflow/instance/' + id + '.json',
			dataType: 'json', // or XML..
			success: function(data) {
				var tracks = data.workflow.mediapackage.media.track;
				if (!$.isArray(tracks)) {
					tracks = [tracks];
	            }
	
				var frames = [];
				for (var i = 0; i < tracks.length; i++) {
					var track = tracks[i];
					if (track.type.indexOf("/source") != -1 && track.video != undefined) {
						frames.push({id: track.id, width: track.video.resolution.split("x")[0], height: track.video.resolution.split("x")[1]});
					}
				}
	            var sources = {frames: frames};
	            processedTemplateData = templateFrames.process(sources);
	            $("#source-frames").html(processedTemplateData);
	            $(".source-frame").draggable({
					containment: $("#holdStateUI"),
					stack: ".source-frame",
					revert: 'invalid'
	            });
				$(".droppable-area").droppable({
					accept: '.source-frame',
					tolerance: 'fit'
				});
			}
		});
        
		var presentation = "";
		var presenter = "";
		var presenterWidth = "";
		var audio = "";
        
		// Get the necessary details about the tracks. 
		$.ajax({
			url: '/workflow/instance/' + id + '.json',
			dataType: 'json', // or XML..
			success: function(data) {

			var tracks = data.workflow.mediapackage.media.track;
			if (!$.isArray(tracks)) {
				tracks = [tracks];
			}

			var frames = [];
			for (var i = 0; i < tracks.length; i++) {
				var track = tracks[i];
				// Find presenter track. 
				if (track.type.indexOf("presenter/source") != -1 && track.video != undefined) {
	           		// frames.push({id: track.id, width: track.video.resolution.split("x")[0], height: track.video.resolution.split("x")[1]});
					presenter = "${.vars[\"" + track.id + "\"]}";
					presenterWidth = track.video.resolution.split("x")[0];
				} 
				// Find presentation track. 
				else if (track.type.indexOf("presentation/source") != -1 && track.video != undefined) {
					presentation = "${.vars[\"" + track.id + "\"]}";
				} 
				// Find audio. 
				else if (track.type.indexOf("/source") != -1 && track.audio != undefined) {
					audio = "${.vars[\"" + track.id + "\"]}";
				}
			}
			
				cameraScreenAudioTemplate = cameraScreenAudioTemplate.replace("VGA", presentation);
				cameraScreenAudioTemplate = cameraScreenAudioTemplate.replace("CAMERAWIDTH", presenterWidth);
				cameraScreenAudioTemplate = cameraScreenAudioTemplate.replace("CAMERA", presenter);
				cameraScreenAudioTemplate = cameraScreenAudioTemplate.replace("AUDIO", audio);
		      
				screenAudioTemplate = screenAudioTemplate.replace("VGA", presentation);
				screenAudioTemplate = screenAudioTemplate.replace("AUDIO", audio);
		      
				mobileTemplate = mobileTemplate.replace("VGA", presentation);
				mobileTemplate = mobileTemplate.replace("AUDIO", audio);
		      
				tabletTemplate = tabletTemplate.replace("VGA", presentation);
				tabletTemplate = tabletTemplate.replace("AUDIO", audio);
				
				hdTemplate = hdTemplate.replace("VGA", presentation);
				hdTemplate = hdTemplate.replace("AUDIO", audio);
				
				fullHDTemplate = fullHDTemplate.replace("VGA", presentation);
				fullHDTemplate = fullHDTemplate.replace("AUDIO", audio);
			}
		});
      	
		var outputFile = "/tmp/output-" + id + ".mp4";
		cameraScreenAudioTemplate = cameraScreenAudioTemplate.replace("OUTPUTFILE", outputFile);
		screenAudioTemplate = screenAudioTemplate.replace("OUTPUTFILE", outputFile);
		mobileTemplate = mobileTemplate.replace("OUTPUTFILE", outputFile);
		tabletTemplate = tabletTemplate.replace("OUTPUTFILE", outputFile);
		hdTemplate = hdTemplate.replace("OUTPUTFILE", outputFile);
		fullHDTemplate = fullHDTemplate.replace("OUTPUTFILE", outputFile);
		$("#gstreamer-output-files").attr("value", outputFile);
		
		$("input:radio").click(function(){
			// Get the template type of the checked radio button. 
			var type = $("input:radio:checked").val();
        	
        	if (type == "CameraScreenAudio") {
				$("#gstreamer-line").attr("value", cameraScreenAudioTemplate);
        	} else if (type == "ScreenAudio") {
        		$("#gstreamer-line").attr("value", screenAudioTemplate);
        	} else if (type == "Mobile") {
        		$("#gstreamer-line").attr("value", mobileTemplate);
        	} else if (type == "Tablet") {
        		$("#gstreamer-line").attr("value", tabletTemplate);
        	} else if (type == "HD") {
        		$("#gstreamer-line").attr("value", hdTemplate);
        	} else if (type == "FullHD") {
        		$("#gstreamer-line").attr("value", fullHDTemplate);
        	}
		});
	});
      
	/**
	* Continues the Workflow
	*/
	function continueWorkflow(){
		postData["org.opencastproject.workflow.config.gstreamer"] = $("#gstreamer-line").val();
        postData["org.opencastproject.workflow.config.gstreamer.outputfiles"] = $("#gstreamer-output-files").val();
        parent.ocRecordings.continueWorkflow(postData);
      }
            
	function cancel(){
		window.parent.location.href = "/admin";
	}
</script>
</head>
  <body>
	  <div class="lectureInfo" style="">
	    <h2 id="info-title"></h2>
	    <h4 id="info-creator"></h4>
	    <h4 id="info-series"></h4>
	  </div>

    <div class="holdStateUI" style="height: 100%; width: 100%;">
      <h1>Export Media</h1>
      <h3>Editing Templates</h3>
      <ul>
	      <li>
	      	<Input type = radio Name = gstreamer-template Value = "CameraScreenAudio">
		  	Camera, Screen and Audio
		  </li>
		  <li>
	      	<Input type = radio Name = gstreamer-template Value = "ScreenAudio">
	      	Screen and Audio
	      </li>
	  </ul>
	  <br>
	  <h3>Scaled Templates</h3>
	  <ul>
	      <li>
	      	<Input type = radio Name = gstreamer-template Value = "Mobile">
	      	Mobile (Scaled to 640 x 480)
	      </li>
	      <li>
	      	<Input type = radio Name = gstreamer-template Value = "Tablet">
	      	Tablet (Scaled to 1024 x 768)
	      </li>
	      <li>
	      	<Input type = radio Name = gstreamer-template Value = "HD">
	      	Scaled to HD (720p, 1280x720)
	      </li>
	      <li>
	      	<Input type = radio Name = gstreamer-template Value = "FullHD">
	      	Scaled to Full HD (1080p, 1920x1080p)
	      </li>
	  </ul>
      <br>
      <h3>gstreamer Command (enter without gst-launch e.g. fakesrc ! fakesink)</h3>
      <textarea id="gstreamer-line" style="width: 100%; height: 30%;" wrap="hard" >Enter Gstreamer Line without gst-launch e.g. fakesrc ! fakesink</textarea>
      <br>
      <h3>Output Files Paths (e.g./tmp/file1,/tmp/file2,/tmp/file3)</h3>
      <textarea id="gstreamer-output-files" style="width: 100%; height: 10%;">Enter output filesnames (with paths) e.g. /tmp/test.mp4 and it will be added to the export download location.</textarea>
      <div style="height: 100%; width: 100%; display: none;">
        <div id="source-frames" class="droppable-area" style="height: 100%; width: 20%; float: left;">
        </div>
        <div id="layout-area" class="droppable-area" style="height: 100%; width: 80%; float: left; border: 1px solid">
        </div>
      </div>

      <div id="actions">
        <input title="Continue processing this template" style="margin-left: 65px; margin-right: 16px; width: 160px;" onclick="continueWorkflow();" id="continueBtn" type="button" class="ui-button ui-corner-all" value="Continue processing" />
        <!-- a id="edit-link" class="secondaryButton">Edit metadata, then continue</a -->
        <a onclick="cancel()" title="Cancel" class="secondaryButton">Cancel</a>
      </div>
    </div>
  </body>
</html>
